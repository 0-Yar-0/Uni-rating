name: Build, Push image, and Deploy to Render

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute lowercase owner
        id: vars
        run: |
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "owner_lower=$OWNER_LOWER" >> $GITHUB_OUTPUT

      - name: Final image tags
        run: |
          echo "IMAGE_SHA=ghcr.io/${{ steps.vars.outputs.owner_lower }}/unirating:${{ github.sha }}"
          echo "IMAGE_LATEST=ghcr.io/${{ steps.vars.outputs.owner_lower }}/unirating:latest"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          no-cache: true
          tags: |
            ghcr.io/${{ steps.vars.outputs.owner_lower }}/unirating:${{ github.sha }}
            ghcr.io/${{ steps.vars.outputs.owner_lower }}/unirating:latest
          platforms: linux/amd64

      - name: Trigger Render deploy (via deploy hook)
        env:
          IMAGE: ghcr.io/${{ steps.vars.outputs.owner_lower }}/unirating:${{ github.sha }}
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          echo "Deploying image: $IMAGE"
          # URL-encode the image string and append to the deploy hook
          ENCODED=$(python -c "import urllib.parse,sys;print(urllib.parse.quote(sys.argv[1], safe=''))" "$IMAGE")
          DEPLOY_URL="${RENDER_DEPLOY_HOOK}&imgURL=${ENCODED}"
          echo "Calling deploy hook: $DEPLOY_URL"
          curl -fsS -X POST "$DEPLOY_URL"

      - name: Wait for deployed service to respond (smoke test)
        env:
          RENDER_SERVICE_URL: ${{ secrets.RENDER_SERVICE_URL }}
        run: |
          if [ -z "$RENDER_SERVICE_URL" ]; then
            echo "RENDER_SERVICE_URL secret is not set — skipping smoke test.";
            exit 0;
          fi
          echo "Waiting for service at $RENDER_SERVICE_URL to return HTTP 200..."
          ATTEMPTS=30
          SLEEP=5
          for i in $(seq 1 $ATTEMPTS); do
            STATUS=$(curl -k -s -o /dev/null -w "%{http_code}" "$RENDER_SERVICE_URL" || true)
            echo "Attempt $i: HTTP $STATUS"
            if [ "$STATUS" = "200" ]; then
              echo "Service is up (HTTP 200). Running a simple content check..."
              # Optional content check: ensure index contains an expected string like '<title>'
              CONTENT=$(curl -k -s "$RENDER_SERVICE_URL")
              if echo "$CONTENT" | grep -q "<title>"; then
                echo "Smoke test passed.";
                exit 0;
              else
                echo "Content check failed — continuing to wait...";
              fi
            fi
            sleep $SLEEP
          done
          echo "Smoke test failed: service did not become ready within timeout.";
          exit 1

      - name: Notify
        run: echo "Deployed image ghcr.io/${{ github.repository_owner }}/unirating:${{ github.sha }} to Render (deploy hook called)."
