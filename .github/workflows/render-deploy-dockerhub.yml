name: Build, Push image to Docker Hub, and Deploy to Render

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Compute lowercase Docker Hub username
        id: dhvars
        run: |
          USER_LOWER=$(echo "${{ secrets.DOCKERHUB_USERNAME }}" | tr '[:upper:]' '[:lower:]')
          echo "dh_user_lower=$USER_LOWER" >> $GITHUB_OUTPUT

      - name: Final image tags
        run: |
          echo "IMAGE_SHA=docker.io/${{ steps.dhvars.outputs.dh_user_lower }}/unirating:${{ github.sha }}"
          echo "IMAGE_LATEST=docker.io/${{ steps.dhvars.outputs.dh_user_lower }}/unirating:latest"

      - name: Build and push Docker image to Docker Hub
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          no-cache: true
          tags: |
            docker.io/${{ steps.dhvars.outputs.dh_user_lower }}/unirating:${{ github.sha }}
            docker.io/${{ steps.dhvars.outputs.dh_user_lower }}/unirating:latest
          platforms: linux/amd64

      - name: Trigger Render deploy (via deploy hook)
        env:
          IMAGE: docker.io/${{ steps.dhvars.outputs.dh_user_lower }}/unirating:${{ github.sha }}
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK" ]; then
            echo "Error: RENDER_DEPLOY_HOOK secret is not set.";
            exit 1;
          fi
          case "$RENDER_DEPLOY_HOOK" in
            http://*|https://*) ;;
            *) echo "Error: RENDER_DEPLOY_HOOK must start with http:// or https://"; exit 1;;
          esac
          HOST=$(python -c "import urllib.parse,sys;print(urllib.parse.urlparse(sys.argv[1]).netloc or '')" "$RENDER_DEPLOY_HOOK")
          echo "Deploy hook host: $HOST"
          echo "Deploying image: $IMAGE"
          ENCODED=$(python -c "import urllib.parse,sys;print(urllib.parse.quote(sys.argv[1], safe=''))" "$IMAGE")
          SEP='?'
          if echo "$RENDER_DEPLOY_HOOK" | grep -q '\?'; then SEP='&'; fi
          DEPLOY_URL="${RENDER_DEPLOY_HOOK}${SEP}imgURL=${ENCODED}"
          echo "Calling deploy hook..."
          curl -fsS -X POST "$DEPLOY_URL"

      - name: Wait for deployed service to respond (smoke test)
        env:
          RENDER_SERVICE_URL: ${{ secrets.RENDER_SERVICE_URL }}
        run: |
          if [ -z "$RENDER_SERVICE_URL" ]; then
            echo "RENDER_SERVICE_URL secret is not set — skipping smoke test.";
            exit 0;
          fi
          echo "Waiting for service at $RENDER_SERVICE_URL to return HTTP 200..."
          ATTEMPTS=30
          SLEEP=5
          for i in $(seq 1 $ATTEMPTS); do
            STATUS=$(curl -k -s -o /dev/null -w "%{http_code}" "$RENDER_SERVICE_URL" || true)
            echo "Attempt $i: HTTP $STATUS"
            if [ "$STATUS" = "200" ]; then
              echo "Service is up (HTTP 200). Running a simple content check..."
              CONTENT=$(curl -k -s "$RENDER_SERVICE_URL")
              if echo "$CONTENT" | grep -q "<title>"; then
                echo "Smoke test passed.";
                exit 0;
              else
                echo "Content check failed — continuing to wait...";
              fi
            fi
            sleep $SLEEP
          done
          echo "Smoke test failed: service did not become ready within timeout.";
          exit 1

      - name: Notify
        run: echo "Deployed image docker.io/${{ secrets.DOCKERHUB_USERNAME }}/unirating:${{ github.sha }} to Render (deploy hook called)."
